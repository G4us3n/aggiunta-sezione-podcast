<?php
define('NOLOGIN',1);
include("includes/global.php");

if(isset($_GET['logout'])) {
	$programActions->programLogout();
	$nome = $userActions->logout();
}
elseif($userActions->userAuthenticated()) {
	header("location: ".$template->getBaseUrl()."index.php");
	die();
}
$vars = array('failures' => $userActions->getFailures(), 'audio' => 0);

if(isset($_GET['error']) && (@$_SESSION['login_redirect'] == 1 || parse_url(@$_SERVER['HTTP_REFERER'], PHP_URL_HOST) == @$_SERVER['HTTP_HOST'])) {
	$_SESSION['login_redirect'] = 0;
	$vars['error_message'] = $_GET['error'];
}
elseif(isset($_POST['email']) && isset($_POST['password'])) {
	try {
		if($vars['failures'] >= 5) {
			$reCaptcha['success'] = 0;
			if(isset($_POST['g-recaptcha-response'])) {
				$reCaptcha = json_decode(file_get_contents(reCaptchaUrl()), true);
			}
			if(!$reCaptcha['success']) {
				throw new Exception('Captcha errato!');
			}
		}
		$nome = $userActions->login($_POST['email'], $_POST['password']);
		$vars['success_message'] = 'Benvenut'.($nome[0] ? 'a' : 'o').' <strong>'.$nome[1].'</strong>, se il tuo browser non effettua il reindirizzamento <a href="index.php">clicca qui</a>.';

		$vars['audio'] = NULL;

		# ale
		if($nome[3] == 63) {
		#	$vars['audio'] = 'calma.mp3';
		}
		# enrica
		elseif ($nome[3] == 73) {
			$vars['audio'] = 'enrica.mp3';
		}
		# marco
		elseif ($nome[3] == 21) {
			$vars['audio'] = 'uncalciatore.mp3';
		}
		$vars['alert_message'] = 'Ciao <strong>'.$nome[1].'</strong>, ci risulta che non hai ancora versato la tua <b>quota associativa</b>.<br>Tale quota aiuta molto la nostra associazione e viene usata per poter gestire il bando e gli imprevisti.<br>Tutti i servizi che la nostra associazione offre <i>gratuitamente</i>, sono anche grazie a questa somma simbolica versata da ogni associato.<br>Puoi versare la tua quota in qualunque momento, mettendoti d\'accordo con lo Station Manager, con il Presidente o con qualunque membro del consiglio direttivo.<br>Se si tratta di un errore, e hai gi&agrave; versato la tua quota, contatta lo Station Manager.<br>Puoi continuare verso alcuni dei servizi offerti dall\'associazione <a href="index.php">cliccando qui</a>, ma ci farebbe molto piacere avere il tuo sostengo con il versamento della quota associativa.';
		$vars['quota_alert'] = $nome[2];

		# phil
		if ($nome[3] == 23) {
			$vars['alert_message'] = 'Ciao <strong>Filippo</strong>, il tuo account &egrave; stato limitato. Ci risulta che non hai ancora pubblicato su mixcloud, sul sito o su facebook il podcast dell\'ultima puntata del tuo programma! Pubblicare il podcast &egrave; molto importante per la nostra associazione, e ci aiuta a mantenere dei contenuti freschi che attirano nuovi utenti. Per favore, pubblica il podcast non appena puoi. Puoi proseguire verso alcuni dei servizi offerti dalla nostra associazione <a href="index.php">cliccando qui</a>.<br>Una volta pubblicato i podcast arretrati, contatta il <b>Dittatrice</b> dei programmi per poter ripristinare lo stato del tuo account. Se si tratta di un errore, contatta invece il responsabile delle disattivazioni dei programmi.';
			$vars['warning'] = 1;
			$vars['quota_alert'] = 0;
			$vars['audio'] = 'phil.mp3';
		}
		/*if ($nome[3] == 76) {
			$vars['alert_message'] = 'Ciao <strong>'.$nome[1].'</strong>, il tuo account &egrave; stato limitato. Ci risulta che hai avuto un comportamento <strong>molto</strong> scorretto nei confronti di alcuni nostri associati. POLI.RADIO non &egrave; solo una radio, ma anche un\'associazione e un luogo di incontro per fare amicizia. Mantenere un atteggiamento <strong>tossico</strong> nei confronti degli associati va contro tutti i principi della nostra associazione. Questo &egrave; il primo ed ultimo avvertimento. Se tali atteggiamenti dovessero continuare, saranno presi provvedimenti.';
			$vars['warning'] = 1;
			$vars['quota_alert'] = 0;
		}*/

		$vars['redirect'] = 'index.php';

	} catch(Exception $e) {
		$vars['error_message'] = $e->getMessage();
		$vars['failures']++;
	}
}
elseif(isset($_GET['code'])) {
	try {
		$userActions->activateUserEmail($_GET['code']);
		$vars['success_message'] = 'Indirizzo email verificato. Attendi ora la conferma di un amministratore';
	} catch(Exception $e) {
		$vars['error_message'] = $e->getMessage();
	}
}
elseif(isset($_GET['pwchanged'])) {
	$vars['success_message'] = 'Password modificata con successo! Sei pregato di rieffettuare il login!';
}
elseif(isset($_GET['emailchanged'])) {
	$vars['success_message'] = 'Email modificata con successo! Sei pregato di rieffettuare il login!';
}
$template->setCustomHeadCode("<script src='https://www.google.com/recaptcha/api.js'></script>");
$template->init('login');
$template->loadTemplate($vars);
?>
